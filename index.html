<html>

<head>
	<script src="lib/jquery-3.0.0.js"></script>
	<script src="lib/nools.js"></script>
	<style>
		#content > div { width:30%; float:left; margin:20px; }
		textarea { width:100%; height:70%; }
	</style>
</head>

<body>
<div id="content">
	<div id="flow">
		<h1>Flow</h1>
		<textarea></textarea>
	</div>
	<div id="test-script">
		<h1>Test script</h1>
		<textarea></textarea>
		<button id="exec">Run</button>
	</div>
	<div id="log">
		<h1>Log</h1>
		<textarea disabled></textarea>
	</div>
</div>

<script>
function clearLog() { $('#log textarea').val(''); }
function log() {
	args = Array.prototype.slice.call(arguments, 0);
	console.log.apply(console, args);

	var ta = $('#log textarea');
	ta.val(ta.val() + 'â€“' + args.join(' ') + '\n');
	ta.scrollTop(ta[0].scrollHeight);
}

function deepEquals(a, b) {
	var i, k;

	if(typeof a !== typeof b) return false;
	if(typeof a === 'boolean') return a === b;
	if(typeof a === 'number') return a === b;
	if(typeof a === 'string') return a === b;
	if(Array.isArray(a)) {
		if(!Array.isArray(b)) return false;
		if(a.length !== b.length) return false;

		for(i=a.length-1; i>=0; --i) {
			if(!deepEquals(a[i], b[i])) return false;
		}
		return true;
	}
	for(k in a) {
		if(a.hasOwnProperty(k)) {
			if(!deepEquals(a[k], b[k])) return false;
		}
	}
	return true;
}

$('#exec').click(function() {
	clearLog();

	var flowScript = $('#flow textarea').val();
	log('Processing flow...');

	var flow;
	try {
		flow = nools.compile(flowScript, { name:'fiddle' });
		log('Flow parsed OK!');
	} catch(e) {
		log('Failed to parse flow.', e);
		throw e;
	}

	var testScript;
	log('Prasing test script...');
	try {
		testScript = JSON.parse($('#test-script textarea').val());
	} catch(e) {
		log('Failed to parse test script.', e);
		throw e;
	}

	log('Executing test...');
	try {
		executeTest(flow, testScript);
	} catch(e) {
		log('Failed to execite test.', e);
		throw e;
	}
});

function executeTest(flow, testScript) {
	var session = flow.getSession();

	var fn, n = -1, cmd;

	function process() {
		for(cmd = testScript.shift(); typeof cmd !== 'undefined'; cmd = testScript.shift()) {
			switch(cmd.type) {
				case 'defined':
					cmd.values.forEach(function(typeName) {
						window[typeName] = flow.getDefined(typeName.toLowerCase());
					});
					break;
				case 'given':
					cmd.values.forEach(function(given) {
						session.assert(eval(given));
					});
					break;
				case 'expect':
					session.match()
						.then(function() {
							var expected = cmd.values;
							log('Getting facts...');
							var facts = session.getFacts();
							log('Facts: ' + JSON.stringify(facts));
							log('Expected: ' + JSON.stringify(expected));
							if(deepEquals(facts, expected)) {
								log('Facts looked ok');
							} else {
								log('Bad facts!!');
								throw new Error('Bad facts!'); // FIXME this does not show up anywhere, and I don't know why
							}
						})
						.then(process)
						.catch(function(err) {
							log(err);
						});
					return;
				default: throw new Error('Unrecognized command type: ' + cmd.type);
			}
		}
		log('Finished.', line, n, lines);
	}

	try {
		process();
	} catch(err) {
		log(err);
	}
}
</script>
</body>

</html>
