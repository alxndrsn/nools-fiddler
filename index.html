<html>

<head>
	<script src="lib/jquery-3.0.0.js"></script>
	<script src="lib/nools.js"></script>
	<style>
		#content > div { width:300px; float:left; margin:20px; }
		textarea { width:100%; height:70%; }
	</style>
</head>

<body>
<div id="content">
	<div id="flow">
		<h1>Flow</h1>
		<textarea></textarea>
	</div>
	<div id="test-script">
		<h1>Test script</h1>
		<textarea></textarea>
		<button id="exec">Run</button>
	</div>
	<div id="log">
		<h1>Log</h1>
		<textarea disabled></textarea>
	</div>
</div>

<script>
function clearLog() { $('#log textarea').val(''); }
function log() {
	args = Array.prototype.slice.call(arguments, 0);
	console.log.apply(console, args);

	var ta = $('#log textarea');
	ta.val(ta.val() + args.join(' ') + '\n\n');
	ta.scrollTop(ta[0].scrollHeight);
}

$('#exec').click(function() {
	clearLog();

	var flowScript = $('#flow textarea').val();
	log('Processing flow...');

	var flow;
	try {
		flow = nools.compile(flowScript, { name:'fiddle' });
		log('Flow parsed OK!');
	} catch(e) {
		log('Failed to parse flow.', e);
		throw e;
	}

	var testScript = $('#test-script textarea').val();
	parseScript(flow, testScript);
});

function parseScript(flow, testScript) {
	var session = flow.getSession();

	var fn, n = 0;
	testScript.split('\n').forEach(function(line) {
		line = line.trim();
		if(line.length === 0) {
			// ignore blank lines
		} else if(line.charAt(line.length-1) === ':') {
			fn = line.substring(0, line.length-1);
			log('Switched fn to: ' + fn);
		} else {
			switch(fn) {
				case 'defined':
					window[line] = flow.getDefined(line.toLowerCase());
					break;
				case 'given':
					session.assert(eval(line));
					break;
				case 'debug!':
					session.match(); // TODO this returns a Promise!!
					log('Facts:' + JSON.stringify(session.getFacts()));
					break;
				default: throw new Error('Unrecognized fn: ' + fn);
			}
		}
		++n;
	});
}
</script>
</body>

</html>
